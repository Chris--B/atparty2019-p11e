#version 460
#define v4 vec4
#define v3 vec3
layout(location=0) in v4 vRot;layout(location=1) in v3 vWorldPos;layout(location=2) in v3 vNormal;layout(location=0) out v4 fragColor;layout(location=1) uniform float uTime;const float PI=3.14159;v4 qmul(v4 q1,v4 q2){return v4((q2.xyz*q1.w)+(q1.xyz*q2.w)+cross(q1.xyz,q2.xyz),(q1.w* q2.w)-dot(q1.xyz,q2.xyz));}v3 rotate_vector(v3 v,v4 r){v4 r_c=r*v4(-1,-1,-1,1);return qmul(r,qmul(v4(v,0),r_c)).xyz;}vec2 circle_5(int fifth){float t=uTime -fifth*(2.*PI) /5;return 17.*vec2(sin(t),cos(t));}v3 rgb(int r,int g,int b){return v3(r,g,b)/255.;}v3 color_z2(float z){return v3(0.9);}v3 color_z(float zz){v3 palette[]={rgb(2,86,208),rgb(0,140,81),rgb(0,140,54),rgb(255,208,10),rgb(255,160,15),rgb(255,70,15),};float i_f=zz*(palette.length() -1);int i_lo=clamp(int(i_f),0,palette.length());int i_hi=clamp(int(i_f+0.5),0,palette.length());return mix(palette[i_lo],palette[i_hi],fract(i_f));}v3 color_0(float z){float t=clamp(0.,1.,uTime-3.);if(uTime<4.){t*=0.6;}return mix(v3(0.8),color_z(z),t);}v3 color_9(float z){return v3(0.8);}void scene_9(){v3 diffuse=v3(0.);for(int x=-5;x<5;x +=1){for(int y=-5;y<5;y+=1){float xx=4.*x+2*(y % 2)-1;float yy=4.*y-5.-2;v3 l_pos=v3(xx,0.,yy);v3 world_pos=vWorldPos;v3 normal=rotate_vector(vNormal,vRot);v3 delta=l_pos -world_pos;float dist=dot(delta,delta);float a=2./(1.+dist*dist);v3 l=normalize(l_pos -world_pos);v3 n=normalize(normal);float discord=dot(n,l);diffuse +=a*color_z((yy+5)/10)*abs(discord);}}fragColor=v4(diffuse,1.);}void scene_0(){int light_cap=int(30.*uTime);int light_count=0;v3 diffuse=v3(0.);for(float r=10.;r<20.;r +=1){for(float k=0;k<1.0;k +=1./12.){if(light_count>light_cap){break;}float t=2.0*PI*k;v3 l_pos=v3(r*cos(t),r*sin(t),3.*sin(r*r)+3.);v3 world_pos=vWorldPos;v3 normal=rotate_vector(vNormal,vRot);if(gl_PrimitiveID <=12){normal=-normalize(world_pos);world_pos=10.*-normal;}v3 delta=l_pos-world_pos;float dist=dot(delta,delta);float a=1. /(1.+dist);a *=mix(0.,1.,clamp(0.,1.,(15.*uTime) -light_count));v3 l=normalize(l_pos -world_pos);v3 n=normalize(normal);float discord=dot(n,l);diffuse +=a*color_0(k)*abs(discord);light_count +=1;}}float x=4-uTime;if(abs(x)>0.12){x=1.;}else{x=sin(PI/2.*x/0.12);}fragColor=v4(x*diffuse,1.);}void main(){if(uTime<8.){scene_0();}else{fragColor=v4(0.,0.,0,1.);}}
